<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub Webhook to Jira Integration System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            color: #333;
            background: #f5f5f5;
        }
        
        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 3rem 0;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        header h1 {
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }
        
        header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem 20px;
        }
        
        .architecture {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            margin: 2rem 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .architecture h2 {
            color: #667eea;
            margin-bottom: 1.5rem;
            font-size: 1.8rem;
        }
        
        .flow-diagram {
            background: #f8f9fa;
            padding: 2rem;
            border-radius: 8px;
            margin: 1.5rem 0;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            overflow-x: auto;
        }
        
        .components {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 2rem;
            margin: 2rem 0;
        }
        
        .component {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            border: 2px solid #e1e4e8;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .component:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .component h3 {
            color: #24292e;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .component .icon {
            font-size: 1.5rem;
        }
        
        .component ul {
            list-style: none;
            padding: 0;
        }
        
        .component li {
            padding: 0.5rem 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .component li:last-child {
            border-bottom: none;
        }
        
        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: bold;
            margin-left: 0.5rem;
        }
        
        .status-active {
            background: #28a745;
            color: white;
        }
        
        .status-pending {
            background: #ffc107;
            color: #333;
        }
        
        .status-process {
            background: #17a2b8;
            color: white;
        }
        
        .directories {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            margin: 2rem 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .directories h2 {
            color: #667eea;
            margin-bottom: 1.5rem;
        }
        
        .dir-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }
        
        .dir-item {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 6px;
            border-left: 4px solid #667eea;
        }
        
        .dir-item strong {
            color: #24292e;
            display: block;
            margin-bottom: 0.5rem;
        }
        
        .dir-item span {
            color: #586069;
            font-size: 0.9rem;
        }
        
        .commands {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            margin: 2rem 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .commands h2 {
            color: #667eea;
            margin-bottom: 1.5rem;
        }
        
        .command-group {
            margin: 1.5rem 0;
        }
        
        .command-group h3 {
            color: #24292e;
            margin-bottom: 1rem;
            font-size: 1.2rem;
        }
        
        .code-block {
            background: #1b1f23;
            color: #e1e4e8;
            padding: 1rem;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            overflow-x: auto;
            margin: 0.5rem 0;
        }
        
        .code-block.bash {
            background: #2d333b;
        }
        
        .comment {
            color: #8b949e;
        }
        
        .configuration {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            margin: 2rem 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .configuration h2 {
            color: #667eea;
            margin-bottom: 1.5rem;
        }
        
        .config-item {
            background: #f6f8fa;
            border: 1px solid #d1d5da;
            border-radius: 6px;
            padding: 1.5rem;
            margin: 1rem 0;
        }
        
        .config-item h4 {
            color: #24292e;
            margin-bottom: 1rem;
        }
        
        .troubleshooting {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 10px;
            padding: 1.5rem;
            margin: 2rem 0;
        }
        
        .troubleshooting h2 {
            color: #856404;
            margin-bottom: 1rem;
        }
        
        .troubleshooting ul {
            margin-left: 1.5rem;
        }
        
        .troubleshooting li {
            margin: 0.5rem 0;
        }
        
        footer {
            background: #24292e;
            color: white;
            text-align: center;
            padding: 2rem 0;
            margin-top: 4rem;
        }
        
        .tag {
            display: inline-block;
            padding: 0.2rem 0.5rem;
            background: #e1e4e8;
            color: #24292e;
            border-radius: 3px;
            font-size: 0.85rem;
            margin: 0.2rem;
        }
        
        .warning {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 4px;
        }
        
        .info {
            background: #d1ecf1;
            border-left: 4px solid #17a2b8;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <header>
        <h1>GitHub Webhook → Claude AI → Jira Integration</h1>
        <p>자동화된 Git 커밋 분석 및 Jira 이슈 업데이트 시스템</p>
    </header>
    
    <div class="container">
        <section class="architecture">
            <h2>📋 시스템 개요</h2>
            <p>이 시스템은 GitHub Push 이벤트를 받아 Claude AI로 자동 분석한 후, 분석 결과를 Jira 이슈에 자동으로 업데이트하는 3단계 파이프라인입니다.</p>
            
            <div class="flow-diagram">
                <pre>
[GitHub Push Event]
        ↓
[github.hook.php] → 웹훅 수신 → pending_webhooks/
        ↓
[claude.analyze.php] → AI 분석 → pending_analysis/
        ↓
[jira.hook.php] → Jira 업데이트 → processed_jira/
                </pre>
            </div>
        </section>

        <section class="components">
            <div class="component">
                <h3><span class="icon">📥</span> Stage 1: Webhook 수신</h3>
                <ul>
                    <li><strong>github.hook.php</strong></li>
                    <li>GitHub 웹훅 이벤트 수신</li>
                    <li>서명 검증 (HMAC-SHA256)</li>
                    <li>JSON 데이터를 pending_webhooks/에 저장</li>
                    <li><span class="status-badge status-active">자동 실행</span></li>
                </ul>
            </div>

            <div class="component">
                <h3><span class="icon">🤖</span> Stage 2: Claude AI 분석</h3>
                <ul>
                    <li><strong>claude.analyze.php</strong></li>
                    <li>pending_webhooks/에서 파일 읽기</li>
                    <li>Claude CLI로 커밋 분석</li>
                    <li>한국어 분석 리포트 생성</li>
                    <li>pending_analysis/에 마크다운 저장</li>
                    <li><span class="status-badge status-process">Cron: 매분 실행</span></li>
                </ul>
            </div>

            <div class="component">
                <h3><span class="icon">📝</span> Stage 3: Jira 업데이트</h3>
                <ul>
                    <li><strong>jira.hook.php</strong></li>
                    <li>pending_analysis/에서 분석 파일 읽기</li>
                    <li>커밋/브랜치에서 Jira 티켓 ID 추출</li>
                    <li>마크다운을 Jira 형식으로 변환</li>
                    <li>Jira REST API로 이슈 업데이트</li>
                    <li><span class="status-badge status-process">Cron: 2분마다 실행</span></li>
                </ul>
            </div>
        </section>

        <section class="directories">
            <h2>📁 디렉토리 구조</h2>
            <div class="dir-grid">
                <div class="dir-item">
                    <strong>pending_webhooks/</strong>
                    <span>GitHub 웹훅 JSON 파일 대기</span>
                </div>
                <div class="dir-item">
                    <strong>pending_analysis/</strong>
                    <span>AI 분석 완료, Jira 업데이트 대기</span>
                </div>
                <div class="dir-item">
                    <strong>processed_webhooks/</strong>
                    <span>분석 완료된 웹훅 파일</span>
                </div>
                <div class="dir-item">
                    <strong>processed_jira/</strong>
                    <span>Jira 업데이트 완료 파일</span>
                </div>
                <div class="dir-item">
                    <strong>logs/</strong>
                    <span>에러 및 성공 로그</span>
                </div>
                <div class="dir-item">
                    <strong>locks/</strong>
                    <span>중복 실행 방지 락 파일</span>
                </div>
                <div class="dir-item">
                    <strong>source/</strong>
                    <span>Git 저장소 클론</span>
                </div>
                <div class="dir-item">
                    <strong>logs/claude_prompts/</strong>
                    <span>Claude 프롬프트 로그</span>
                </div>
            </div>
        </section>

        <section class="commands">
            <h2>⚙️ 주요 명령어</h2>
            
            <div class="command-group">
                <h3>수동 실행</h3>
                <div class="code-block bash">
<span class="comment"># 웹훅 처리 및 Claude 분석</span>
php claude.analyze.php

<span class="comment"># Jira 업데이트</span>
php jira.hook.php

<span class="comment"># Shell 대안 (PHP curl 없을 때)</span>
./jira_integration.sh

<span class="comment"># 잘못 배치된 분석 파일 이동</span>
./move_analysis_files.sh
                </div>
            </div>

            <div class="command-group">
                <h3>테스트 명령어</h3>
                <div class="code-block bash">
<span class="comment"># Jira API 연결 테스트</span>
php test_jira_connection.php

<span class="comment"># 테스트 웹훅 데이터 생성</span>
php test_webhook.php

<span class="comment"># 분석 기능 테스트</span>
php test_analyze.php
                </div>
            </div>

            <div class="command-group">
                <h3>Crontab 설정 (자동화 필수)</h3>
                <div class="code-block bash">
<span class="comment"># crontab -e 에 추가:</span>
* * * * * cd /var/www/html/webhookTest && php claude.analyze.php >> logs/cron_analyze.log 2>&1
*/2 * * * * cd /var/www/html/webhookTest && php jira.hook.php >> logs/cron_jira.log 2>&1
* * * * * /var/www/html/webhookTest/move_analysis_files.sh >> logs/file_mover.log 2>&1
                </div>
            </div>

            <div class="command-group">
                <h3>Docker 운영</h3>
                <div class="code-block bash">
<span class="comment"># Docker 컨테이너 빌드 및 실행</span>
cd docker/
docker-compose up -d

<span class="comment"># 컨테이너 접속</span>
docker exec -it webhooktest_web_1 bash

<span class="comment"># 로그 확인</span>
docker logs webhooktest_web_1
                </div>
            </div>
        </section>

        <section class="configuration">
            <h2>🔧 환경 설정</h2>
            
            <div class="config-item">
                <h4>.env 파일 (필수)</h4>
                <div class="code-block">
JIRA_BASE_URL=https://your-domain.atlassian.net
JIRA_EMAIL=your-email@example.com
JIRA_API_TOKEN=your-api-token
WEBHOOK_SECRET=test123
                </div>
            </div>

            <div class="config-item">
                <h4>GitHub Webhook 설정</h4>
                <ul>
                    <li><strong>Payload URL:</strong> https://your-domain.com/webhookTest/github.hook.php</li>
                    <li><strong>Content type:</strong> application/json</li>
                    <li><strong>Secret:</strong> .env의 WEBHOOK_SECRET와 동일</li>
                    <li><strong>Events:</strong> Just the push event 선택</li>
                </ul>
            </div>

            <div class="config-item">
                <h4>디렉토리 권한</h4>
                <div class="code-block bash">
chmod 755 *.php *.sh
chmod 777 pending_* processed_* logs/
                </div>
            </div>
        </section>

        <section class="architecture">
            <h2>✨ 주요 기능</h2>
            
            <div class="info">
                <h4>Claude AI 분석</h4>
                <ul>
                    <li>Git diff 기반 변경사항 분석</li>
                    <li>한국어 요약 생성 (주요 변경사항, 영향 모듈, 변경 목적)</li>
                    <li>병합 충돌 감지 및 특별 처리</li>
                    <li>대량 커밋 시 자동 요약 모드</li>
                </ul>
            </div>

            <div class="info">
                <h4>Jira 티켓 ID 추출</h4>
                <ul>
                    <li>패턴: [P03-45], PROJ-123, ABC1-234</li>
                    <li>커밋 메시지 우선 검색</li>
                    <li>브랜치명 폴백 검색</li>
                </ul>
            </div>

            <div class="info">
                <h4>마크다운 → Jira 변환</h4>
                <ul>
                    <li>헤더: # → h1., ## → h2.</li>
                    <li>굵은 글씨: **text** → *text*</li>
                    <li>코드: `code` → {{code}}</li>
                    <li>코드 블록: ```code``` → {code}code{code}</li>
                    <li>이모지 변환 지원</li>
                </ul>
            </div>
        </section>

        <section class="troubleshooting">
            <h2>🔍 문제 해결</h2>
            <ul>
                <li><strong>Lock 파일 에러:</strong> locks/ 디렉토리의 오래된 락 파일 삭제</li>
                <li><strong>Jira 401/403:</strong> API 토큰 및 권한 확인</li>
                <li><strong>분석 파일이 루트에 생성:</strong> move_analysis_files.sh 스크립트 실행</li>
                <li><strong>Claude 분석 실패:</strong> Claude CLI 설치 확인 (which claude)</li>
                <li><strong>웹훅 미수신:</strong> GitHub webhook secret이 .env와 일치하는지 확인</li>
            </ul>
            
            <div class="warning">
                <strong>⚠️ 주의사항:</strong>
                <ul>
                    <li>PHP 8.2+ 및 curl extension 필요</li>
                    <li>Claude CLI 설치 필수</li>
                    <li>Crontab 설정 없으면 자동화 안됨</li>
                    <li>analysis_*.md 파일이 루트에 생성되면 move_analysis_files.sh 실행</li>
                </ul>
            </div>
        </section>

        <section class="architecture">
            <h2>📊 로그 파일</h2>
            <div class="dir-grid">
                <div class="dir-item">
                    <strong>webhook_errors.log</strong>
                    <span>GitHub 웹훅 수신 오류</span>
                </div>
                <div class="dir-item">
                    <strong>analysis_errors.log</strong>
                    <span>Claude 분석 오류</span>
                </div>
                <div class="dir-item">
                    <strong>jira_hook_errors.log</strong>
                    <span>Jira API 오류</span>
                </div>
                <div class="dir-item">
                    <strong>jira_success.log</strong>
                    <span>Jira 업데이트 성공 기록</span>
                </div>
                <div class="dir-item">
                    <strong>cron_analyze.log</strong>
                    <span>분석 Cron 실행 로그</span>
                </div>
                <div class="dir-item">
                    <strong>cron_jira.log</strong>
                    <span>Jira Cron 실행 로그</span>
                </div>
            </div>
        </section>
    </div>
    
    <footer>
        <p>GitHub Webhook to Jira Integration System v1.0</p>
        <p>Powered by Claude AI | PHP 8.2+ | Docker</p>
    </footer>
</body>
</html>